<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>FORMULARIO EXTRA SEGURO</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }

    img.logo {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 140px;
    }

    h2 {
      text-align: center;
      margin-top: 120px;
      background-color: #ccc;
      padding: 10px;
      width: 95%;
      margin-left: auto;
      margin-right: auto;
      border-radius: 8px;
    }

    h3 {
      text-align: center;
      margin-top: 50px;
      margin-bottom: 15px;
    }

    .form-group, .form-group2, .form-group3 {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
      width: 100%;
    }

    .form-group label, .form-group2 label, .form-group3 label {
      display: flex;
      flex-direction: column;
      text-align: center;
    }

    .form-group3 label {
      width: 20%;
    }

    input {
      margin-top: 7px;
      text-align: center;
    }

    .canvas-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 60px;
      margin-bottom: 20px;
    }

    .clear-button {
      margin: 20px;
    }

    table {
      border-collapse: collapse;
      width: 90%;
      margin: auto;
      margin-top: 25px;
      table-layout: fixed;
    }

    th, td {
      border: 1px solid #000;
      padding: 7px;
      text-align: left;
    }

    td input {
      width: 100%;
      box-sizing: border-box;
    }
  </style>
</head>
<body>

  <img src="Cars.JPG" alt="Logo Cars" class="logo">

  <h2>FORMULARIO EXTRA SEGURO</h2>

  <form id="dataForm">
    <div class="form-group">
      <label>Taller: <input type="text" id="taller" required></label>
      <label>Serie y Número: <input type="text" id="serieNumero" required></label>
      <label>Fecha: <input type="date" id="fecha" required></label>
    </div>

    <div class="form-group2">
      <label>Siniestro: <input type="text" id="siniestro" required></label>
    </div>

    <div class="canvas-section">
      <canvas id="canvas" width="500" height="350"></canvas>
      <button class="clear-button" type="button" onclick="clearCanvas()">Limpiar Dibujo</button>
    </div>

    <div class="form-group3">
      <label>Dificulta visual?: <input type="text" id="dificultadVisual"></label>
    </div>

    <h3>SE INFORMAN RUBROS CUYOS PORCENTAJES NO SE TENDRAN EN CUENTA EN FUTURAS RECLAMACIONES ANULA / REMPLAZA EXTRA SEGURO DE FECHA:</h3>

    <table id="tablaPiezas">
      <thead>
        <tr>
          <th>PIEZA / ACCESORIOS</th>
          <th>CHAPA</th>
          <th>PINTURA</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>Guardabarro del der</td><td><input type="text"></td><td><input type="text"></td></tr>
        <tr><td>Guardabarro del izq</td><td><input type="text"></td><td><input type="text"></td></tr>
        <tr><td>Parabrisas</td><td><input type="text"></td><td><input type="text"></td></tr>
        <!-- Agrega más filas según necesites -->
      </tbody>
    </table>

    <div style="text-align:center; margin: 30px 0;">
      <button type="submit">Generar PDF</button>
    </div>
  </form>

  <!-- LIBRERÍAS PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <!-- SCRIPT FUNCIONAL -->
  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let baseImageData = null;
    let userHasDrawn = false;

    const image = new Image();
    image.src = 'parabrisa.png'; // debe estar en la misma carpeta
    image.crossOrigin = 'anonymous';
    image.onload = () => {
      ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
      baseImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    };

    let drawing = false;

    function getPos(evt) {
      const rect = canvas.getBoundingClientRect();
      return evt.touches ? {
        x: evt.touches[0].clientX - rect.left,
        y: evt.touches[0].clientY - rect.top
      } : {
        x: evt.offsetX,
        y: evt.offsetY
      };
    }

    function startDraw(evt) {
      evt.preventDefault();
      drawing = true;
      const pos = getPos(evt);
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
    }

    function draw(evt) {
      if (!drawing) return;
      evt.preventDefault();
      const pos = getPos(evt);
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = 'red';
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
      userHasDrawn = true;
    }

    function endDraw(evt) {
      evt.preventDefault();
      drawing = false;
      ctx.beginPath();
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseleave', endDraw);

    canvas.addEventListener('touchstart', startDraw, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', endDraw);
    canvas.addEventListener('touchcancel', endDraw);

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
      userHasDrawn = false;
    }

    window.clearCanvas = clearCanvas;

    window.onload = () => {
      const { jsPDF } = window.jspdf;

      document.getElementById('dataForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const taller = document.getElementById('taller').value.trim();
        const serieNumero = document.getElementById('serieNumero').value.trim();
        const siniestro = document.getElementById('siniestro').value.trim();
        const fecha = document.getElementById('fecha').value.trim();
        const dificultadVisual = document.getElementById('dificultadVisual').value.trim();

        if (!taller || !serieNumero || !siniestro || !fecha) {
          alert("Por favor complete todos los campos antes de generar el PDF.");
          return;
        }

        if (userHasDrawn && !dificultadVisual) {
          alert("Si realizaste un dibujo, completá el campo 'Dificulta visual'.");
          return;
        }

        const pdf = new jsPDF();
        pdf.text(`Taller: ${taller}`, 10, 20);
        pdf.text(`Serie y Número: ${serieNumero}`, 10, 30);
        pdf.text(`Siniestro: ${siniestro}`, 10, 40);
        pdf.text(`Fecha: ${fecha}`, 10, 50);
        pdf.text(`Dificultad visual: ${dificultadVisual}`, 10, 60);

        try {
          const imgData = canvas.toDataURL("image/png");
          pdf.addImage(imgData, 'PNG', 10, 70, 180, 120);
        } catch (error) {
          alert("Error al convertir el canvas. Asegúrate de usar Live Server.");
          return;
        }

        const table = document.getElementById('tablaPiezas').cloneNode(true);
        const inputs = table.querySelectorAll('input');
        inputs.forEach(input => {
          const td = input.parentElement;
          td.textContent = input.value;
        });

        pdf.autoTable({ html: table, startY: 195 });
        pdf.save("formulario_con_dibujo.pdf");
      });
    };
  </script>

</body>
</html>
